<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bluetooth Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #080c10;
    --panel: #0d1520;
    --border: #1a2e44;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --green: #00ff88;
    --dim: #2a4a6a;
    --text: #c8dff0;
    --muted: #4a7090;
    --glow: 0 0 12px rgba(0,229,255,0.4);
    --glow2: 0 0 12px rgba(0,255,136,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 860px;
    margin: 0 auto;
    padding: 28px 20px 60px;
  }

  /* Header */
  header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo-block h1 {
    font-family: 'Share Tech Mono', monospace;
    font-size: 26px;
    letter-spacing: 0.12em;
    color: var(--accent);
    text-shadow: var(--glow);
    line-height: 1;
  }

  .logo-block .sub {
    font-size: 12px;
    letter-spacing: 0.2em;
    color: var(--muted);
    text-transform: uppercase;
    margin-top: 6px;
    font-family: 'Share Tech Mono', monospace;
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    transition: all 0.3s;
    flex-shrink: 0;
  }

  .status-dot.scanning {
    background: var(--accent);
    box-shadow: var(--glow);
    animation: pulse 1.2s ease-in-out infinite;
  }

  .status-dot.connected {
    background: var(--green);
    box-shadow: var(--glow2);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.7); }
  }

  /* Control bar */
  .controls {
    display: flex;
    gap: 12px;
    margin-bottom: 28px;
    flex-wrap: wrap;
  }

  .btn {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 12px 24px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: transparent;
    border: 1.5px solid var(--accent);
    color: var(--accent);
    box-shadow: inset 0 0 0 0 var(--accent);
  }

  .btn-primary:hover:not(:disabled) {
    background: rgba(0,229,255,0.08);
    box-shadow: var(--glow), inset 0 0 0 0 var(--accent);
    text-shadow: var(--glow);
  }

  .btn-primary:active:not(:disabled) {
    transform: scale(0.97);
  }

  .btn-secondary {
    background: transparent;
    border: 1.5px solid var(--border);
    color: var(--muted);
  }

  .btn-secondary:hover:not(:disabled) {
    border-color: var(--accent2);
    color: var(--accent2);
  }

  .btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .btn-danger {
    background: transparent;
    border: 1.5px solid #ff4444;
    color: #ff4444;
  }

  .btn-danger:hover:not(:disabled) {
    background: rgba(255,68,68,0.08);
  }

  /* Scanning animation */
  .scan-ring-wrap {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px 0 20px;
    position: relative;
  }

  .scan-ring-wrap.hidden { display: none; }

  .scan-rings {
    position: relative;
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ring {
    position: absolute;
    border-radius: 50%;
    border: 1.5px solid var(--accent);
    opacity: 0;
    animation: expand 2.4s ease-out infinite;
  }

  .ring:nth-child(1) { animation-delay: 0s; }
  .ring:nth-child(2) { animation-delay: 0.8s; }
  .ring:nth-child(3) { animation-delay: 1.6s; }

  @keyframes expand {
    0%   { width: 30px; height: 30px; opacity: 0.8; }
    100% { width: 120px; height: 120px; opacity: 0; }
  }

  .scan-icon {
    width: 38px;
    height: 38px;
    color: var(--accent);
    filter: drop-shadow(0 0 6px rgba(0,229,255,0.6));
    animation: rotateIcon 3s linear infinite;
  }

  @keyframes rotateIcon {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(0.9); }
  }

  .scan-label {
    text-align: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    letter-spacing: 0.15em;
    margin-bottom: 32px;
    animation: blink 1.5s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Device list */
  .section-title {
    font-size: 11px;
    font-family: 'Share Tech Mono', monospace;
    letter-spacing: 0.2em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .device-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 28px;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    border: 1px dashed var(--border);
    border-radius: 4px;
    color: var(--muted);
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    letter-spacing: 0.1em;
  }

  .device-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px 20px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 16px;
    transition: all 0.25s;
    animation: slideIn 0.3s ease-out;
    cursor: default;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-12px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  .device-card:hover {
    border-color: var(--dim);
    background: #101d2e;
  }

  .device-card.is-connected {
    border-color: rgba(0,255,136,0.4);
    background: #0a1e14;
  }

  .device-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1.5px solid var(--dim);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent);
    flex-shrink: 0;
    font-size: 18px;
  }

  .device-card.is-connected .device-icon {
    border-color: var(--green);
    color: var(--green);
  }

  .device-meta { min-width: 0; }

  .device-name {
    font-weight: 700;
    font-size: 16px;
    color: var(--text);
    letter-spacing: 0.04em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .device-id {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    margin-top: 3px;
    letter-spacing: 0.08em;
  }

  .device-badge {
    display: inline-block;
    font-size: 9px;
    font-family: 'Share Tech Mono', monospace;
    letter-spacing: 0.12em;
    padding: 2px 7px;
    border-radius: 2px;
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.25);
    color: var(--accent);
    margin-left: 8px;
    vertical-align: middle;
  }

  .device-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .btn-sm {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 7px 16px;
    border-radius: 3px;
    border: 1.5px solid var(--dim);
    background: transparent;
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm.connected-btn { border-color: rgba(255,68,68,0.5); color: #ff6666; }
  .btn-sm.connected-btn:hover { border-color: #ff4444; }
  .btn-sm:disabled { opacity: 0.35; cursor: not-allowed; }

  /* Connected panel */
  .connected-panel {
    background: var(--panel);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 28px;
    animation: fadeIn 0.4s ease-out;
  }

  .connected-panel.hidden { display: none; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .conn-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .conn-title {
    font-weight: 700;
    font-size: 18px;
    color: var(--green);
    text-shadow: var(--glow2);
    letter-spacing: 0.05em;
  }

  .conn-subtitle {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
  }

  .service-chip {
    background: #060e16;
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 10px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.07em;
    word-break: break-all;
  }

  .service-chip .service-label {
    font-size: 10px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 4px;
  }

  /* Log */
  .log-box {
    background: #050b12;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 14px 16px;
    max-height: 180px;
    overflow-y: auto;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  .log-entry {
    display: flex;
    gap: 12px;
    animation: fadeIn 0.2s;
  }

  .log-time { color: var(--dim); flex-shrink: 0; }
  .log-msg  { color: var(--muted); }
  .log-msg.info  { color: var(--accent); }
  .log-msg.success { color: var(--green); }
  .log-msg.error { color: #ff5555; }
  .log-msg.warn  { color: var(--accent2); }

  /* Not supported warning */
  .warning-box {
    background: rgba(255,107,53,0.08);
    border: 1px solid rgba(255,107,53,0.3);
    border-radius: 4px;
    padding: 16px 20px;
    margin-bottom: 24px;
    font-size: 14px;
    color: var(--accent2);
    display: none;
    align-items: flex-start;
    gap: 12px;
  }

  .warning-box.show { display: flex; }
  .warning-icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
  .warning-text a { color: var(--accent); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--dim); }

  /* Responsive */
  @media (max-width: 500px) {
    .device-card { grid-template-columns: auto 1fr; }
    .device-actions { grid-column: 1 / -1; justify-content: flex-end; }
    header { flex-direction: column; gap: 14px; }
    .controls { gap: 8px; }
    .btn { padding: 10px 16px; font-size: 13px; }
  }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="logo-block">
      <h1>⬡ BLUETOOTH SCANNER</h1>
      <div class="sub">Web Bluetooth · Scan &amp; Connect</div>
    </div>
    <div class="status-pill">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">IDLE</span>
    </div>
  </header>

  <!-- Browser warning -->
  <div class="warning-box" id="warningBox">
    <span class="warning-icon">⚠</span>
    <div class="warning-text">
      <strong>Web Bluetooth not supported</strong> in this browser.<br/>
      Use <strong>Chrome</strong> or <strong>Edge</strong> on desktop/Android.
      <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Bluetooth_API#browser_compatibility" target="_blank">Browser compatibility →</a>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn btn-primary" id="scanBtn" onclick="startScan()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      SCAN ALL DEVICES
    </button>
    <button class="btn btn-secondary" id="clearBtn" onclick="clearDevices()">CLEAR LIST</button>
  </div>

  <!-- Scanning animation -->
  <div class="scan-ring-wrap hidden" id="scanAnim">
    <div class="scan-rings">
      <div class="ring"></div>
      <div class="ring"></div>
      <div class="ring"></div>
      <svg class="scan-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8.5 6.5A5 5 0 0 1 12 5a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-3.5-1.5"/>
        <path d="M12 1v3M12 20v3M1 12h3M20 12h3"/>
        <path d="M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/>
      </svg>
    </div>
  </div>
  <div class="scan-label hidden" id="scanLabel">SCANNING FOR BLUETOOTH DEVICES...</div>

  <!-- Connected device panel -->
  <div class="connected-panel hidden" id="connectedPanel">
    <div class="conn-header">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2"><path d="M12 22V12M12 12L8 8M12 12L16 8M8 16l4 4 4-4"/></svg>
      <div>
        <div class="conn-title" id="connName">–</div>
        <div class="conn-subtitle" id="connSub">CONNECTED</div>
      </div>
      <button class="btn btn-danger" style="margin-left:auto;font-size:12px;padding:8px 14px;" onclick="disconnectActive()">DISCONNECT</button>
    </div>
    <div class="section-title" style="margin-bottom:10px">Services Discovered</div>
    <div class="services-grid" id="servicesGrid">
      <div class="service-chip"><div class="service-label">Status</div>Discovering services…</div>
    </div>
  </div>

  <!-- Device list -->
  <div class="section-title">ESP32 Devices Found <span id="devCount"></span></div>
  <div class="device-list" id="deviceList">
    <div class="empty-state" id="emptyState">
      No devices found yet.<br/>Press SCAN to discover nearby Bluetooth devices.
    </div>
  </div>

  <!-- Log -->
  <div class="section-title">System Log</div>
  <div class="log-box" id="logBox"></div>

</div>

<script>
  // ─── State ───────────────────────────────────────────────
  const devices = new Map();     // id → { device, gatt, name, connected }
  let activeDevice = null;

  // ─── UI helpers ─────────────────────────────────────────
  const $ = id => document.getElementById(id);

  function setStatus(state, text) {
    const dot = $('statusDot');
    dot.className = 'status-dot' + (state ? ' ' + state : '');
    $('statusText').textContent = text;
  }

  function log(msg, type = 'default') {
    const box = $('logBox');
    const now = new Date();
    const ts = now.toTimeString().slice(0,8);
    const el = document.createElement('div');
    el.className = 'log-entry';
    el.innerHTML = `<span class="log-time">${ts}</span><span class="log-msg ${type}">${msg}</span>`;
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
    // keep max 120 lines
    while (box.children.length > 120) box.removeChild(box.firstChild);
  }

  function showScanAnim(show) {
    $('scanAnim').classList.toggle('hidden', !show);
    $('scanLabel').classList.toggle('hidden', !show);
  }

  function updateCount() {
    const c = devices.size;
    $('devCount').textContent = c > 0 ? `(${c})` : '';
  }

  function renderDevices() {
    const list = $('deviceList');
    list.innerHTML = '';
    if (devices.size === 0) {
      list.innerHTML = '<div class="empty-state">No devices found yet.<br/>Press SCAN to discover nearby Bluetooth devices.</div>';
      updateCount();
      return;
    }
    for (const [id, info] of devices) {
      const isConnected = info.connected;
      const badge = getDeviceBadge(info.name);
      const card = document.createElement('div');
      card.className = 'device-card' + (isConnected ? ' is-connected' : '');
      card.id = 'card-' + id;
      card.innerHTML = `
        <div class="device-icon">${isConnected ? '✓' : '⬡'}</div>
        <div class="device-meta">
          <div class="device-name">${escHtml(info.name)}${badge ? `<span class="device-badge">${badge}</span>` : ''}</div>
          <div class="device-id">ID: ${escHtml(id)}</div>
        </div>
        <div class="device-actions">
          ${isConnected
            ? `<button class="btn-sm connected-btn" onclick="disconnectDevice('${id}')">DISCONNECT</button>`
            : `<button class="btn-sm" onclick="connectDevice('${id}')">CONNECT</button>`
          }
        </div>`;
      list.appendChild(card);
    }
    updateCount();
  }

  function getDeviceBadge(name) {
    if (!name) return 'UNKNOWN';
    const n = name.toLowerCase();
    if (n.includes('esp32') || n.includes('esp_') || n.includes('espressif')) return 'ESP32';
    if (n.includes('esp8266') || n.includes('esp8285')) return 'ESP8266';
    if (n.includes('arduino')) return 'ARDUINO';
    if (n.includes('raspberry') || n.includes('rpi')) return 'RPI';
    if (n.includes('hm-10') || n.includes('ble')) return 'BLE';
    return '';
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ─── Check Web Bluetooth support ────────────────────────
  function checkSupport() {
    if (!navigator.bluetooth) {
      $('warningBox').classList.add('show');
      $('scanBtn').disabled = true;
      log('Web Bluetooth API not available in this browser.', 'error');
      return false;
    }
    return true;
  }

  // ─── Scan ────────────────────────────────────────────────
  // ESP32 detection: filter by name prefix "ESP32" or common ESP32 service UUIDs
  // Web Bluetooth requires explicit filters — we use name prefix + acceptAllDevices as fallback option
  async function startScan() {
    if (!checkSupport()) return;

    $('scanBtn').disabled = true;
    setStatus('scanning', 'SCANNING...');
    showScanAnim(true);
    log('Initiating Bluetooth scan — showing all nearby devices...', 'info');

    try {
      // Show ALL nearby Bluetooth devices — no filter
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [
          '0000180a-0000-1000-8000-00805f9b34fb', // Device Information
          '0000180f-0000-1000-8000-00805f9b34fb', // Battery
          '0000ffe0-0000-1000-8000-00805f9b34fb', // HM-10 / common ESP32 serial
          '6e400001-b5a3-f393-e0a9-e50e24dcca9e', // Nordic UART
          '0000ff00-0000-1000-8000-00805f9b34fb',
          '00001800-0000-1000-8000-00805f9b34fb',
          '00001801-0000-1000-8000-00805f9b34fb',
        ]
      });

      addDevice(device);
      log(`Found: ${device.name || device.id}`, 'success');
      log('Press CONNECT on the device card to establish a connection.', 'default');

    } catch (err) {
      if (err.name === 'NotFoundError') {
        log('No ESP32 device selected or found.', 'warn');
      } else if (err.name === 'SecurityError') {
        log('Bluetooth permission denied. Please allow Bluetooth access.', 'error');
      } else {
        log(`Scan error: ${err.message}`, 'error');
      }
    } finally {
      $('scanBtn').disabled = false;
      setStatus('', 'IDLE');
      showScanAnim(false);
    }
  }

  function addDevice(device) {
    if (!devices.has(device.id)) {
      devices.set(device.id, { device, gatt: null, name: device.name || `ESP32 (${device.id.slice(0,8)})`, connected: false });
      // Listen for disconnection
      device.addEventListener('gattserverdisconnected', () => onDisconnected(device.id));
    }
    renderDevices();
  }

  // ─── Connect ─────────────────────────────────────────────
  async function connectDevice(id) {
    const info = devices.get(id);
    if (!info) return;

    log(`Connecting to ${info.name}...`, 'info');
    setStatus('scanning', 'CONNECTING...');

    // Disable all connect buttons
    document.querySelectorAll('.btn-sm').forEach(b => b.disabled = true);

    try {
      const server = await info.device.gatt.connect();
      info.gatt = server;
      info.connected = true;
      activeDevice = id;

      setStatus('connected', 'CONNECTED');
      log(`Connected to ${info.name}!`, 'success');
      renderDevices();
      showConnectedPanel(info, server);

    } catch (err) {
      log(`Connection failed: ${err.message}`, 'error');
      setStatus('', 'IDLE');
      renderDevices();
    }
  }

  // ─── Show connected panel ────────────────────────────────
  async function showConnectedPanel(info, server) {
    const panel = $('connectedPanel');
    panel.classList.remove('hidden');
    $('connName').textContent = info.name;
    $('connSub').textContent = `GATT SERVER · ${info.device.id.slice(0, 16)}...`;
    $('servicesGrid').innerHTML = '<div class="service-chip"><div class="service-label">Status</div>Discovering…</div>';

    try {
      const services = await server.getPrimaryServices();
      if (services.length === 0) {
        $('servicesGrid').innerHTML = '<div class="service-chip"><div class="service-label">Info</div>No services found</div>';
        log('No GATT services found on this device.', 'warn');
        return;
      }

      $('servicesGrid').innerHTML = '';
      for (const svc of services) {
        const name = resolveServiceName(svc.uuid);
        const chip = document.createElement('div');
        chip.className = 'service-chip';
        chip.innerHTML = `<div class="service-label">${escHtml(name.label)}</div>${escHtml(svc.uuid)}`;
        $('servicesGrid').appendChild(chip);
      }
      log(`Discovered ${services.length} GATT service(s).`, 'success');

    } catch (err) {
      $('servicesGrid').innerHTML = `<div class="service-chip"><div class="service-label">Error</div>${escHtml(err.message)}</div>`;
      log(`Service discovery error: ${err.message}`, 'error');
    }
  }

  // ─── Known service name map ───────────────────────────────
  const SERVICE_NAMES = {
    '0000180a-0000-1000-8000-00805f9b34fb': { label: 'Device Info' },
    '0000180f-0000-1000-8000-00805f9b34fb': { label: 'Battery' },
    '00001800-0000-1000-8000-00805f9b34fb': { label: 'Generic Access' },
    '00001801-0000-1000-8000-00805f9b34fb': { label: 'Generic Attribute' },
    '0000ffe0-0000-1000-8000-00805f9b34fb': { label: 'Serial (HM-10)' },
    '6e400001-b5a3-f393-e0a9-e50e24dcca9e': { label: 'Nordic UART' },
    '0000ff00-0000-1000-8000-00805f9b34fb': { label: 'Custom FF00' },
    '00001810-0000-1000-8000-00805f9b34fb': { label: 'Blood Pressure' },
    '0000181c-0000-1000-8000-00805f9b34fb': { label: 'User Data' },
  };

  function resolveServiceName(uuid) {
    return SERVICE_NAMES[uuid.toLowerCase()] || { label: 'Custom Service' };
  }

  // ─── Disconnect ───────────────────────────────────────────
  async function disconnectDevice(id) {
    const info = devices.get(id);
    if (!info) return;
    if (info.device.gatt.connected) {
      info.device.gatt.disconnect();
    }
  }

  function disconnectActive() {
    if (activeDevice) disconnectDevice(activeDevice);
  }

  function onDisconnected(id) {
    const info = devices.get(id);
    if (!info) return;
    info.connected = false;
    if (activeDevice === id) {
      activeDevice = null;
      $('connectedPanel').classList.add('hidden');
    }
    setStatus('', 'IDLE');
    log(`Disconnected from ${info.name}.`, 'warn');
    renderDevices();
  }

  // ─── Clear ────────────────────────────────────────────────
  function clearDevices() {
    for (const [id, info] of devices) {
      if (info.connected) disconnectDevice(id);
    }
    devices.clear();
    activeDevice = null;
    $('connectedPanel').classList.add('hidden');
    renderDevices();
    setStatus('', 'IDLE');
    log('Device list cleared.', 'default');
  }

  // ─── Init ────────────────────────────────────────────────
  checkSupport();
  log('Bluetooth Scanner ready. Press SCAN to discover all nearby devices.', 'info');
</script>
</body>
</html>